---
title: Kibanaä¸­KQLçš„ä½¿ç”¨
tags: []
id: '620'
categories:
  - - Linux
    - ElasticSearch
date: 2020-08-26 21:17:33
cover: /static/uploads/2020/08/Monasterio_Khor_Virap_Armenia_2016-10-01_DD_25.jpg
---



## å‰è¨€

å½“æˆ‘ä»¬éœ€è¦æŸ¥çœ‹ ElasticSearch ä¸­å­˜æ”¾çš„æ•°æ®æ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨ Kibana è¿™ä¸ªå¯è§†åŒ–å·¥å…·ã€‚ ä½†æ˜¯ Kibana ä¸­çš„ Discover é¡µé¢é»˜è®¤åªä¼šå±•ç¤ºæœ€è¿‘æ”¶åˆ°çš„æ•°æ®ï¼Œå½“æˆ‘ä»¬éœ€è¦æŸ¥è¯¢ç¬¦åˆæŸä¸ªæ¡ä»¶æ•°æ®æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ° KQL(Kibana Query Language) äº†ï¼Œæ²¡æœ‰æ¥è§¦ä¹‹å‰è§‰å¾—é«˜å¤§ä¸Šï¼Œçœ‹å®Œä¹‹åæ‰å‘ç°è®¾è®¡å¦‚æ­¤ç®€å•ã€‚ è‹±æ–‡è¿˜å¯ä»¥çš„åŒå­¦å¯ä»¥ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç»“åˆæ•°æ®å®ä¾‹è¿›è¡Œè®²è§£ï¼Œä¹Ÿæ¯”è¾ƒæ¸…æ™° å®˜æ–¹æ–‡æ¡£ï¼š[https://www.elastic.co/guide/en/kibana/current/kuery-query.html#kuery-query](https://www.elastic.co/guide/en/kibana/current/kuery-query.html#kuery-query)

## ç­›é€‰è¯­æ³•

å°†æ‰€æœ‰æ¶‰åŠåˆ°çš„è¯­æ³•é“ºå±•å¼€æ¥ï¼Œé¦–å…ˆå‡†å¤‡å¥½å®˜ç½‘æ–‡æ¡£ä¸­çš„æ•°æ®å¦‚ä¸‹ï¼š

```json
{
  "grocery_name": "Elastic Eats",
  "items": [
    {
      "name": "banana",
      "stock": "12",
      "category": "fruit"
    },
    {
      "name": "peach",
      "stock": "10",
      "category": "fruit"
    },
   {
      "name": "peach test",
      "stock": "10",
      "category": "fruit"
    },
    {
      "name": "carrot",
      "stock": "9",
      "category": "vegetable"
    },
    {
      "name": "broccoli",
      "stock": "5",
      "category": "vegetable"
    }
  ]
}
```

éœ€è¦æ ¹æ®å®é™…æƒ…å†µåšå°è¯•çš„æ—¶å€™è¿›å…¥ Kibana çš„ Discoveré¡µé¢åœ¨è¾“å…¥æ¡†ä¸­å¡«å…¥ç­›é€‰å³å¯ã€‚ [![](/static/uploads/2020/08/bf38129fb9a6a1d593feb32d28b50582.png)](/static/uploads/2020/08/bf38129fb9a6a1d593feb32d28b50582.png)

> ç”Ÿäº§ç¯å¢ƒæˆªå›¾ä¸ä¾¿è¿˜è¯·è°…è§£ ğŸ˜

### ç®€å•æŸ¥è¯¢

ç®€å•æŸ¥è¯¢å°±æ˜¯ å…³é”®å­—åŒ¹é…ã€å­—ç¬¦ä¸²åŒ…å«ç­‰ï¼Œæ¯”å¦‚è¯´å¦‚ä¸‹è¯­å¥ä¼šæ‰¾å‡º name å­—æ®µæ˜¯ banana çš„æ‰€æœ‰æ•°æ®ï¼š

```kql
name: banana
```

ä½†æ˜¯å¦‚æœ name åŒ…å« `peach` å’Œ `peach test`ï¼Œç„¶åä¸‹é¢ä¸¤ä¸ªè¯­å¥æŸ¥å‡ºæ¥ä¼šæ˜¯ä¸¤ä¸ªç»“æœã€‚

```kql
name: peach test
```

ä¸Šè¿°æŸ¥è¯¢ä¼šå°† name æ˜¯ `peach` å’Œ name æ˜¯ `peach test` çš„éƒ½ç»™æŸ¥å‡ºæ¥

```kql
name: "peach test"
```

ä¸Šè¿°æŸ¥è¯¢åªä¼šå°† `peach test` æŸ¥å‡ºæ¥ï¼Œå› ä¸ºå¦‚æœä¸åŠ å¼•å·ä¼šè‡ªåŠ¨å…³é”®å­—åˆ†è¯ï¼Œå°†åŒ…å«è¯¥å…³é”®å­—çš„æ‰€æœ‰æ•°æ®åŒ¹é…å‡ºæ¥ã€‚

### æ¡ä»¶è¿ç®—ç¬¦

æ¡ä»¶è¿ç®—ç¬¦å°±æ˜¯ > >= < <=ï¼Œåœ¨ KQL é‡Œè¾¹éƒ½æ”¯æŒï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œæ¯”å¦‚å¦‚ä¸‹è¯­å¥è¡¨ç¤º age å­—æ®µå¤§äºç­‰äº 10ã€‚

```kql
age >= 10
```

### é€»è¾‘è¿ç®—ç¬¦

æŸ¥è¯¢è¯­è¨€è‡ªç„¶å°‘ä¸äº†é€»è¾‘è¿ç®—ç¬¦ ä¸æˆ–éï¼Œåœ¨ KQL ä¸­ä»£è¡¨äº† and or not and çš„ç”¨æ³•ï¼š

```kql
age >= 10 and age < 100
```

ä¸Šè¿°è¯­å¥è¡¨ç¤ºæŸ¥è¯¢å‡º age åœ¨ 10 åˆ° 100 çš„å·¦å¼€å³é—­åŒºé—´ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚ or çš„ç”¨æ³•ï¼š

```kql
name: "Jeff" or name: "Kitty"
```

ä¸Šè¿°è¯­å¥è¡¨ç¤ºç­›é€‰å‡º name åŒ…å« `Jeff` æˆ–è€… `Kitty` å…³é”®å­—çš„æ‰€æœ‰æ•°æ®ã€‚ not çš„ç”¨æ³•ï¼š

```kql
not age >= 10
```

ä¸Šè¿°è¯­å¥è¡¨ç¤ºç­›é€‰å‡º age å°äº 10 çš„æ‰€æœ‰æ•°æ®ã€‚ å…¶ä¸­ and çš„ä¼˜å…ˆçº§æ¯” or çš„é«˜

```kql
age < 100 or name: wang and age >= 10
```

and ä¼˜å…ˆçº§é«˜ä¼šå…ˆç»“åˆï¼Œæ‰€ä»¥æ„æ€æ˜¯ æ»¡è¶³ name æ˜¯wang age >= 10 æˆ–è€… age < 100ã€‚ å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å°æ‹¬å·æ¥æ”¹å˜ä¼˜å…ˆçº§ï¼Œæ¯”å¦‚ï¼š

```kql
(age < 100 or name: wang) and age >= 10
```

æ„æ€æ˜¯ age >=10 å¹¶ä¸”è¿™æ¡æ•°æ®çš„ nameæ˜¯wangæˆ–è€…age < 100

#### åŒä¸€å­—æ®µè¿ç®—ç¬¦ç®€å†™

å¯ä»¥ç”¨æ‹¬å·å°†å¤šä¸ªé€»è¾‘è¿ç®—ç¬¦å’Œæ¡ä»¶åˆå¹¶åˆ°ä¸€èµ·

```kql
age = 10 or age = 100
# ç­‰ä»·äº
age: ( 10 or 100)
```

### é€šé…ç¬¦

é€šé…ç¬¦å¯ä»¥ç”¨äºæŸ¥æ‰¾å‡ºå­˜åœ¨æŸä¸ªkeyçš„æ•°æ®

```kql
name: *
```

è¡¨ç¤ºæŸ¥æ‰¾å‡ºæ‰€æœ‰å¸¦ name å­—æ®µçš„æ•°æ®

```kql
system: win*
```

å¯ä»¥åŒ¹é…åˆ° system: win7ï¼Œsystem: win10 ç­‰ã€‚

### å­—æ®µåµŒå¥—æŸ¥è¯¢

é¦–å…ˆå‡†å¤‡ä¸€ä¸ªå¤šå±‚çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸‹é¢çš„è¿™å‡ æ¡æ•°æ®ã€‚

```json
{
  "level1": [
    {
      "level2": [
        {
          "prop1": "foo",
          "prop2": "bar"
        },
        {
          "prop1": "baz",
          "prop2": "qux"
        }
      ]
    }
  ]
}
```

æ¯”å¦‚æƒ³ç­›é€‰ level1.level2.prop1 æ˜¯ `foo` æˆ–è€…æ˜¯ `baz`çš„ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```kql
level1.level2 { prop1: "foo" or prop1: "baz" }
```

## æ€»ç»“

KQLæ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•ç­›é€‰æ•°æ®çš„æŸ¥è¯¢è¯­è¨€ï¼ŒåŒ…æ‹¬æ¡ä»¶ã€é€»è¾‘ã€å¤šå±‚æŸ¥è¯¢ç­‰ç”¨æ³•ï¼Œèƒ½è¾…åŠ©æŠ¥è¡¨çš„åˆ¶ä½œå’Œå®æ—¶æ—¥å¿—çš„ç­›é€‰ã€‚