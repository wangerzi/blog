---
title: ä½¿ç”¨ Golang å¿«é€Ÿå®ç°å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨è§£å†³å¤§æ•°æ®åˆ¤é‡é—®é¢˜
date: 2022-05-17 22:08:41
tags:
- Hash
- ç®—æ³•
- å¤§æ•°æ®
categories: ç®—æ³•
cover: ../../static/bird.jpg
---

## å‰è¨€

ä¸šåŠ¡ä¸­æ—¶å¸¸ä¼šæœ‰ç±»ä¼¼**æ£€ç´¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­è¿™æ ·çš„åœºæ™¯**ï¼Œå¦‚æœå¯¹æ—¶é—´å’Œç©ºé—´è¦æ±‚ä¸é«˜ï¼Œæˆ‘ä»¬å¯èƒ½ä¼š

- æŸ¥è¡¨ï¼Œæˆ–è€…å»ºå”¯ä¸€ç´¢å¼•é¿å…é‡å¤æ’å…¥

- Redis ä¸­ä½¿ç”¨ set æˆ–è€…ç±»ä¼¼ hash è¡¨çš„æ•°æ®ç»“æ„ï¼Œå°†æ•°æ®åš hash åæ”¾åˆ° key ä¸Šï¼Œä»¥å¾…åç»­æŸ¥è¯¢

è€Œå½“æˆ‘ä»¬æœ‰**å¤§é‡æ•°æ®**éœ€è¦åˆ¤é‡å¹¶ä¸”ä¸šåŠ¡**å…è®¸å°æ¦‚ç‡è¯¯é˜³**åˆ¤æ–­çš„å‰æä¸‹

- ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åšå¤§é‡æ•°æ®éš¶å±åˆ¤æ–­ï¼Œä½†ç”±äºåº•å±‚å®ç°çš„åŸå› ï¼Œæ— æ³•åˆ é™¤å†å²å·²åŠ å…¥é›†åˆçš„æ•°æ®

- ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨çš„å‡çº§ç‰ˆï¼Œæ¯”å¦‚ counting bloom å°±å¯ä»¥æ”¯æŒåˆ é™¤ï¼Œä½†ä»£ä»·æ˜¯ä¸‰åˆ°å››å€çš„ç©ºé—´å ç”¨

ä½† 2014 å¹´çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰äº†å¦ä¸€ä¸ªé€‰æ‹©ï¼Œå¤–ç½‘æœ‰ä½å¤§å“¥æå‡ºäº†å¸ƒéš†é¸Ÿè¿‡æ»¤å™¨æ¥è§£å†³å¤§é‡æ•°æ®åˆ¤é‡çš„é—®é¢˜ï¼Œå¹¶ä¸”æ”¯æŒåˆ é™¤

è®ºæ–‡åœ°å€ï¼š https://www.cs.cmu.edu/~dga/papers/cuckoo-conext2014.pdf

å›½å†…ç¿»è¯‘ï¼š[å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼šå®é™…ä¸Šä¼˜äºå¸ƒéš†è¿‡æ»¤å™¨](http://www.linvon.cn/posts/cuckoo/#sec31)

å¼€æºå®ç°ï¼š[cuckoo-filter/cuckoofilter.go at main Â· linvon/cuckoo-filter Â· GitHub](https://github.com/linvon/cuckoo-filter/blob/main/cuckoofilter.go)

> è¯‘è€…éå¸¸ä¹‹æœ‰è€å¿ƒï¼Œç¿»è¯‘åˆ°ä½å¹¶è§£ç­”äº†æˆ‘åœ¨ç†è§£è¿‡ç¨‹ä¸­äº§ç”Ÿçš„éƒ¨åˆ†ç–‘æƒ‘ï¼ŒğŸ‘

é€šè¯»è®ºæ–‡å’Œéƒ¨åˆ†ä»£ç åï¼Œå¤§è‡´ç†è§£äº†å…¶å®ç°åŸç†ï¼Œè§‰ç€è¿™ä¸ªç®—æ³•éå¸¸å·§å¦™ï¼Œå°±äº§ç”Ÿäº†è‡ªå·±åŠ¨æ‰‹å®ç°åŠ æ·±ç†è§£çš„æƒ³æ³•

é€šè¿‡åšå®¢è®°å½•ä¸‹æ¥ï¼Œ**åŒæ—¶ä¹Ÿè®©è¯»è€…èƒ½æ›´å¿«çš„æŒæ¡å…¶ä¸­å…³é”®ï¼Œä¸å¿…é€šè¯»è®ºæ–‡å’Œå®ç°ä»£ç **ã€‚

> PSï¼šä¸Šé¢ç»™åˆ°çš„å¼€æºå®ç°ä¹Ÿæ˜¯ Golang åšçš„ï¼Œè‡ªå®šä¹‰å‚æ•°çš„åŠŸèƒ½å¼ºå¤§ï¼Œä½†å®šåˆ¶æ€§é«˜å¸¦æ¥çš„å°±æ˜¯åº•å±‚å®ç°å¤æ‚ï¼Œä¸ä¾¿äºåˆå­¦è€…ç†è§£

## å®ç°å…³é”®

### æ•°æ®ç»“æ„

ç†è§£ä¸€ä¸ªç®—æ³•ç¬¬ä¸€æ­¥å°±æ˜¯äº†è§£å®ƒçš„å­˜å‚¨ç»“æ„ï¼Œç†è§£åº•å±‚æ•°æ®ç»“æ„åï¼Œç®—æ³•éšåçš„å·§å¦™æ„æ€éƒ½ä¼šå›´ç»•æ•°æ®ç»“æ„å±•å¼€

#### æ™®é€šçš„ Hash

ä¼—æ‰€å‘¨çŸ¥ï¼Œæ™®é€šçš„ Hash è¡¨çš„å·¥ä½œåŸç†æ˜¯ç»™å†…å®¹ç”Ÿæˆä¸€æ®µ **â€œå”¯ä¸€â€çš„æ‘˜è¦**ï¼Œç„¶åæ˜ å°„åˆ°ç´¢å¼•æ•°ç»„ä¸Šï¼Œå¹¶åœ¨æ•°ç»„çš„æ¯ä¸€é¡¹ä¸Šå¤–æŒ‚é“¾è¡¨æˆ–è€…æ•°ç»„å¼€æ”¾å¯»å€ä»¥è§£å†³ Hash å†²çª

ç»“æ„å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

![](../static/assets/2022-05-18-22-52-13-image.png)

ç½‘ä¸Šæ‰¾äº†ä¸€ç¯‡ä»‹ç»æ™®é€š Hash çš„æ–‡ç« ï¼Œå¦‚æœ‰ä¸ç†è§£å¯é€šè¯»æ­¤ç¯‡ï¼š[Hashè¡¨ - Matrixæµ·å­ - åšå®¢å›­](https://www.cnblogs.com/dolphin0520/archive/2012/09/28/2700000.html)

#### å¸ƒè°·é¸Ÿ Hash

è€Œå¸ƒè°·é¸Ÿ hash ä¸åŒï¼Œåˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ¦‚å¿µ

- æŒ‡çº¹ï¼šåŸå§‹æ•°æ®ç”Ÿæˆçš„ **â€œå”¯ä¸€â€ æ ‡å¿—**

- æ¡¶ï¼šå¯¹åº”ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ¡¶å¯ä»¥å­˜å‚¨å¤šä¸ªæŒ‡çº¹

- æ¡¶æ•°ç»„ï¼šå¯¹åº”å¤šä¸ªæ¡¶ï¼Œå¯ä»¥**ç†è§£ä¸ºä¸€ä¸ªå­˜æŒ‡çº¹çš„äºŒç»´æ•°ç»„**

**ã€é‡ç‚¹ã€‘** å¸ƒè°·é¸Ÿ Hash åœ¨æ’å…¥æ•°æ®æ—¶æ˜¯è¿™æ ·ç»´æŠ¤æ¡¶æ•°ç»„çš„ï¼š

- é€šè¿‡ä¸¤ä¸ª hash å‡½æ•°å’ŒåŸå§‹æ•°æ® x ç®—å‡ºä¸¤ä¸ªå€™é€‰æ¡¶çš„ä½ç½®ï¼Œ**ç§°ä¸º h1 å’Œ h2**

- ä» h1 æ¡¶å’Œ h2 æ¡¶ä¸­éšæœºæ‰¾ä¸€ä¸ªæ”¾æ•°æ®æŒ‡çº¹

- ä¸€ä¸ªæ¡¶å¯å­˜å‚¨çš„æŒ‡çº¹æ˜¯æœ‰é™çš„
  
  - å¦‚æœæ²¡æ»¡ï¼Œå°±å¾€åè¿½åŠ å­˜å‚¨å³å¯
  
  - å¦‚æœå­˜æ»¡äº†ï¼Œå°±åœ¨æ¡¶ä¸­éšæœºæ‰¾ä¸€ä¸ªä½ç½®ï¼ŒæŠŠåŸæœ‰çš„è¸¢å‡ºå»ï¼Œæ–°çš„æŒ‡çº¹æ”¾åˆ°é‚£ä¸ªä½ç½®

- å¦‚æœè¿‡ç¨‹ä¸­è¸¢å‡ºå»äº†ï¼ˆKick outï¼‰ä¸€ä¸ªå…ƒç´ ï¼Œè¢«è¸¢å‡ºå»çš„å…ƒç´ **å°±ä¼šæ‰¾å…¶å¯¹åº”çš„å¦ä¸€ä¸ªå€™é€‰æ¡¶**
  
  - æ¯”å¦‚æŸä¸ªå…ƒç´  xï¼Œ**æœ‰å›ºå®šçš„ä¸¤ä¸ªå€™é€‰æ¡¶** hx1 å’Œ hx2ï¼Œé€šè¿‡éšæœºé€‰æ‹©é¡ºåˆ©çš„**å°†æŒ‡çº¹**å­˜æ”¾åˆ°äº† hx1 ä¸­
  
  - ç„¶åæ–°åŠ äº†ä¸€ä¸ªå…ƒç´  bï¼Œæœ‰å›ºå®šçš„ä¸¤ä¸ªå€™é€‰æ¡¶ hb1 å’Œ hb2ï¼Œä½†ä¸å·§çš„æ˜¯ **hb1 å’Œ hx1 ç›¸åŒ** ï¼ˆhb2 å’Œ hx2 å†æ¬¡ç›¸åŒçš„æ¦‚ç‡æ¯”è¾ƒä½ï¼Œæ‰€ä»¥å…ˆä¸è€ƒè™‘è¿™ä¸ªæƒ…å†µï¼‰
  
  - å‡è®¾å…ƒç´ b å¯¹åº”çš„ä¸¤ä¸ªå€™é€‰æ¡¶éƒ½æ»¡äº†ï¼Œé€šè¿‡éšæœºé€‰æ‹©ï¼Œé€‰åˆ°äº† hb1ï¼ˆä¹Ÿå°±æ˜¯ hx1ï¼‰ä¸­å…ƒç´  x çš„æŒ‡çº¹ï¼Œx çš„æŒ‡çº¹å°±è¢«è¸¢å‡ºå»äº†
  
  - x çš„æŒ‡çº¹è¸¢å‡ºå»ä¹‹åæ”¾å“ªå„¿å‘¢ï¼Œå®ƒè¿˜æœ‰**å¦ä¸€ä¸ªé€‰æ‹©å°±æ˜¯ hx2**ï¼Œé€šè¿‡ hash ç®—æ³•æ‰¾åˆ° hx2
    
    - å¦‚æœ hx2 æœªæ»¡ï¼Œå°† x çš„æŒ‡çº¹åŠ è¿›å»
    
    - å¦‚æœ hx2 æ»¡äº†ï¼Œå°† x çš„æŒ‡çº¹åŠ è¿›å»ï¼Œéšæœºè¸¢ä¸€ä¸ªå‡ºå»ï¼Œé‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°æˆåŠŸæˆ–è€…è¶…å‡ºæœ€å¤§è¸¢å‡ºé™åˆ¶

![1](http://www.linvon.cn/img/cuckoo/1.jpg)

è¿™æ ·åšå°±ä¼šå§‹ç»ˆ**ä¿è¯æŸä¸ªå…ƒç´  x å¯¹åº”çš„æŒ‡çº¹ä¸€å®šåœ¨ hx1 æ¡¶æˆ–è€… hx2 æ¡¶ä¸­**ï¼ŒæŸ¥æ‰¾å’Œåˆ é™¤çš„æ—¶å€™å°±é¡ºç€è¿™ä¸ªè§„å¾‹æ‰¾å³å¯

ç”±äºå¸ƒè°·é¸Ÿå“ˆå¸Œå¹¶ä¸å­˜å‚¨åŸæ–‡ï¼Œä»…å­˜å‚¨ **â€œå”¯ä¸€â€** æŒ‡çº¹ï¼Œä¸Šè¿°è®¾è®¡è¿˜æœ‰å‡ ä¸ªéšè—çš„é—®é¢˜ï¼š

- å¸ƒè°·é¸Ÿ Hash æ²¡æœ‰å­˜å‚¨åŸæ–‡ï¼Œè¸¢å‡ºå…ƒç´ æ—¶æˆ‘ä»¬åªä¼šè·å–åˆ° hx1ï¼ˆæˆ– hx2ï¼‰ä»¥åŠæŒ‡çº¹ï¼Œ**æ€ä¹ˆä» hx1 æ¨ç®—å‡º hx2å‘¢**ï¼Ÿï¼ˆæˆ–è€…åè¿‡æ¥ï¼‰

- æŒ‡çº¹æ˜¯æœ‰é•¿åº¦é™åˆ¶çš„ï¼Œå¦‚æœè®¾ç½®è¿‡çŸ­ï¼Œ**æŒ‡çº¹å†²çªçš„å¯èƒ½æ€§å°±å¾ˆé«˜**ï¼Œæ¯”å¦‚ 8 ä½æŒ‡çº¹æœ€å¤šèƒ½è¡¨ç¤º 2 çš„ 8 æ¬¡æ–¹ä¸ªæŒ‡çº¹ï¼Œä¹Ÿå°±æ˜¯ 256 ç§ï¼ŒæŒ‡çº¹çš„å†²çªä¼šä¸ä¼šå¯¼è‡´é˜³æ€§ç‡å‡é«˜å‘¢ï¼Ÿ

- å¦‚æœæˆ‘ä»¬æ’å…¥å¾ˆå¤šé‡å¤çš„å…ƒç´ ï¼Œ**ä»–ä»¬çš„å€™é€‰æ¡¶ä¸€æ ·ï¼ŒæŒ‡çº¹ä¹Ÿä¸€æ ·**ï¼Œè¸¢æ¥è¸¢å»ä¹Ÿæ’å…¥ä¸è¿›å»ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä¸å°±é™·å…¥æ­»å¾ªç¯äº†ï¼Ÿ

##### ã€é‡ç‚¹ã€‘è¸¢å‡ºæ—¶ h1 å’Œ h2 å€™é€‰æ¡¶ä¹‹é—´çš„è½¬æ¢

**æ ‡å‡†çš„å¸ƒè°·é¸Ÿ hashï¼Œç¡®å®æ˜¯éœ€è¦ç”¨ä¸¤ä¸ª Hash ç®—æ³•**ï¼Œé€šè¿‡åŸæ–‡ç®—å‡ºä¸¤ä¸ªå€™é€‰æ¡¶çš„

ä½†å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨é‡Œè¾¹ï¼Œå¯¹è¿™ä¸ª hash è®¡ç®—åšäº†ä¼˜åŒ–ï¼Œ**è®¾è®¡äº†ä¸€ä¸ªå…¬å¼å¯ä»¥è®© h1 å’Œ h2 äº’ç›¸è½¬æ¢**

> h1(x) = hash(x), h2(x) = h1(x) âŠ• hash(xâ€™s fingerprint)
> 
> ä¸¤è€…å¯ä»¥é€šè¿‡åŒä¸€ä¸ªå…¬å¼ç›¸äº’è½¬æ¢
> 
> h1(x) = h2(x) âŠ• hash(fingerprint)
> 
> h2(x) = h1(x) âŠ• hash(fingerprint)

æ‰€ä»¥**è¸¢å‡ºæ—¶åªéœ€è¦ä½¿ç”¨æŒ‡çº¹å’Œå…¶ä¸­ä¸€ä¸ªå€™é€‰æ¡¶ï¼Œå°±å¯ä»¥æ±‚åˆ°å¦ä¸€ä¸ªå€™é€‰æ¡¶çš„ä½ç½®äº†**

##### æŒ‡çº¹è¿‡çŸ­çš„å†²çª

æŒ‡çº¹è®¾ç½®å¾ˆçŸ­é€ æˆè¡¨è¾¾èƒ½åŠ›æœ‰é™ï¼Œæ¯”å¦‚ 8ä½æœ€å¤šè¡¨ç¤º 256 ä¸ªæŒ‡çº¹ï¼Œä½†å¹¶ä¸ä»£è¡¨å¸ƒè°·é¸Ÿ Hash æ•´ä½“è¡¨è¾¾èƒ½åŠ›æœ‰é™

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬åšäº† 8 ä½æŒ‡çº¹ï¼Œæœ‰ä¸ª 1024 ä¸ªæ¡¶

å‡è®¾æœ‰è¿™ä¹ˆä¸€ä¸ªç‰¹æ®Šæ•°æ® a å’Œ bï¼Œä»–ä¿©æŒ‡çº¹ç›¸åŒï¼Œä½†é€šè¿‡ hash æ˜ å°„åˆ°çš„å€™é€‰æ¡¶å´ä¸ä¸€å®šç›¸åŒï¼Œ**å› ä¸ºæŒ‡çº¹çš„ç”Ÿæˆå’Œæ¡¶çš„é€‰å–æ˜¯ä¸¤ä¸ªè¿‡ç¨‹**

å‡è®¾å†æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ® c å’Œ dï¼Œä»–ä¿©æŒ‡çº¹ç›¸åŒï¼Œè€Œä¸”ä¸¤ä¸ªå€™é€‰æ¡¶ä¹Ÿä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ•°æ®å°±ä¼šæœ‰**å‡é˜³æ€§**ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæˆ‘æŠŠ c æ”¾å…¥äº†å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ä¸­ï¼Œæˆ‘åˆ¤æ–­ d æ˜¯å¦å­˜åœ¨äºè¿‡æ»¤å™¨ä¸­ï¼Œä¼šè¿”å› true

> æ‰©å±•ä¸‹ï¼Œå¯ä»¥æ ¹æ®å‚æ•°æ¨ç®—å‡ºå‡é˜³æ€§ç¢°æ’çš„æ¦‚ç‡ï¼Œåªæœ‰æŒ‡çº¹ç›¸åŒå’Œ hash å€™é€‰æ¡¶ç›¸åŒæ‰ä¼šæœ‰é˜³æ€§ï¼Œå¼•ç”¨è®ºæ–‡çš„æè¿°
> 
> è®©æˆ‘ä»¬é¦–å…ˆæ¨å¯¼ç»™å®šä¸€ä¸ªå«æœ‰qä¸ªé¡¹çš„é›†åˆåœ¨åŒä¸€ä¸ªæ¡¶ä¸­ç¢°æ’çš„æ¦‚ç‡ã€‚å‡è®¾ç¬¬ä¸€ä¸ªé¡¹xæœ‰å®ƒçš„ç¬¬ä¸€ä¸ªæ¡¶Â i_1Â å’Œä¸€ä¸ªæŒ‡çº¹Â t_xã€‚å¦‚æœå…¶ä»– q-1 ä¸ªé¡¹å’Œè¿™ä¸ªé¡¹ x æœ‰ç›¸åŒçš„ä¸¤ä¸ªæ¡¶ï¼Œå®ƒä»¬å¿…é¡»[3](http://www.linvon.cn/posts/cuckoo/#fn:3):
> 
> ï¼ˆ1ï¼‰å…·æœ‰ç›¸åŒçš„æŒ‡çº¹ï¼Œå‘ç”Ÿæ¦‚ç‡ä¸º 1/2^f
> 
> ï¼ˆ2ï¼‰ç¬¬ä¸€ä¸ªå­˜å‚¨æ¡¶ä¸º i_1æˆ– i_1âŠ•h()ï¼Œå‘ç”Ÿæ¦‚ç‡ä¸º2/m
> 
> å› æ­¤ï¼Œè¿™äº›qä¸ªé¡¹å…±äº«ç›¸åŒä¸¤ä¸ªå­˜å‚¨æ¡¶çš„æ¦‚ç‡ä¸º (2/mÂ·1/2^f)^q-1

##### é‡å¤æ•°æ®å¯¼è‡´æ— é™è¸¢å‡º

è¿™ä¸ªé—®é¢˜æ˜¯åˆ‡å®å­˜åœ¨çš„ï¼Œå‡è®¾æ¯ä¸ªæ¡¶å¯ä»¥å­˜ b ä¸ªæŒ‡çº¹ï¼Œé‚£ä¹ˆä¸éš¾æƒ³åˆ°ï¼Œé‡å¤å…ƒç´ æœ€å¤šèƒ½å ç”¨ 2 * b ä¸ªç©ºé—´ï¼Œç„¶åå°±è¸¢ä¸åŠ¨äº†

æ‰€ä»¥è¦ä¹ˆå°±æ˜¯å…ˆåˆ¤é‡å†åŠ å…¥ï¼Œå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è¦ä¹ˆå°±æ˜¯é‡å¤æ•°æ®ä¸è¦è¶…è¿‡é¢„è®¾

## ä»£ç æ‹†è§£

å®Œæ•´ä»£ç å¯äº [code/cuckoo-filter](https://github.com/wangerzi/blog/tree/master/source/static/assets/code/cuckoo-filter) å¤„æŸ¥çœ‹ï¼ŒåŒ…å«åŸºç¡€å®ç°å’Œéƒ¨åˆ†æ ¸å¿ƒç”¨ä¾‹

### åŸºç¡€å¯¹è±¡å®šä¹‰å’Œæ“ä½œ

è¿™ä¸ªçš„çº¦æŸéƒ½æ˜¯æœ‰ä½œç”¨çš„ï¼Œä»¥ä¾¿å°†å®ç°å¤æ‚åº¦çº¦æŸåœ¨ä¸€ç¯‡åšå®¢çš„èŒƒå›´å†…

- æ¡¶çš„æ•°é‡è½¬æ¢ä¸º 2 çš„æ¬¡å¹‚æ˜¯å› ä¸º **2çš„æ¬¡å¹‚å–ä½™æ•°æœ‰å¿«æ·çš„ä½è¿ç®—ç®—æ³•**

- æŒ‡çº¹çš„ä½æ•°ä¸€å®šè¦æ˜¯ 8 çš„å€æ•°ï¼Œ**å› ä¸º 8 ä½æ˜¯ä¸€ä¸ªå­—èŠ‚å­˜èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿**ï¼ŒæŒ‡çº¹ä½æ•°å³ç§»3å°±æ˜¯éœ€è¦çš„å­—èŠ‚æ•°äº†

- bucket ç”¨ uint8ï¼Œä¹Ÿæ˜¯å› ä¸º **uint8 ä»£è¡¨ä¸€ä¸ªå­—èŠ‚**ï¼Œè·ŸæŒ‡çº¹çš„ä½æ•°å°½å¯èƒ½åŒ¹é…èµ·æ¥ï¼Œåˆ¤ç©ºä¹Ÿæ–¹ä¾¿ï¼Œç”¨ byte ä¹Ÿæ˜¯ä¸€æ ·çš„æ•ˆæœ

```go
const MaxKickOut = 500

type CuckooFilter struct {
    m uint64 // æœ‰å¤šå°‘ä¸ªæ¡¶ï¼Œå¼ºåˆ¶è½¬æ¢ä¸º 2 çš„æ¬¡å¹‚
    b uint64 // æ¯ä¸ªæ¡¶èƒ½å­˜å¤šå°‘ä¸ªæŒ‡çº¹
    f uint64 // æ¯ä¸ªæŒ‡çº¹å¤šå°‘ä½ï¼Œæ–¹ä¾¿å®ç°ï¼Œéœ€è¦æ˜¯ 8 çš„å€æ•°ï¼Œä¸”å°äº 24 * 8ï¼Œä¸ç„¶ hash ä¸å¤Ÿç”¨
    bucket []uint8 // å®é™…å­˜æ”¾æ¡¶çš„ç©ºé—´
}

// New m ä¸ºæ¡¶çš„æ•°é‡ï¼Œb ä¸ºæ¯ä¸ªæ¡¶å†…å«æŒ‡çº¹æ•°é‡ï¼Œf ä¸ºæŒ‡çº¹é•¿åº¦ï¼ŒNew(1<<10, 4, 8)
func New(m uint64, b uint64, f uint64) (*CuckooFilter, error) {
    // ç¡®ä¿ m ä¸º 2 çš„ n æ¬¡å¹‚ï¼Œç¡®ä¿ f ä¸º 8 çš„å€æ•°
    if !checkPow2(m) {
        return nil, errors.New("m needs 2^n")
    }
    if remain, err := fastRemain(f, 8); err != nil || remain > 0 || f < 8 {
        return nil, errors.New("m needs 8*n and > 0")
    }
    return &CuckooFilter{
        m:      m,
        b:      b,
        f:      f,
        bucket: make([]uint8, m * b * (f >> 3)), // åˆ†é…çš„ bit å¤§å°æ˜¯ m * n * f/8
    }, nil
}

// checkPow2 æ£€æŸ¥æ˜¯å¦ä¸º 2 çš„æ•´æ¬¡å¹‚
func checkPow2(a uint64) bool {
    return a & (a-1) == 0
}

// fastRemain æ±‚ a % bï¼Œå‰ææ˜¯ b éœ€è¦æ˜¯ 2 çš„æ¬¡å¹‚, remain = a & (b - 1)
func fastRemain(a uint64, b uint64) (uint64, error) {
    if !checkPow2(b) {
        return 0, errors.New("fast remain failed")
    }
    return a & (b - 1), nil
}
```

##### ã€æ ¸å¿ƒã€‘è®¡ç®— h1 ã€ finger ä»¥åŠ h2

è®¡ç®—æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯å–äº†ä¸ªå·§ï¼Œå€ŸåŠ© sha256 è¿”å›çš„å›ºå®š 32 å­—èŠ‚æ•°æ®ï¼Œé¦– 8 å­—èŠ‚å–å‡ºæ¥**æ­£å¥½å¯ä»¥è¡¨è¾¾ uint64ï¼Œå¯¹æ¡¶æ•°é‡å–ä½™å³å¯å¾—åˆ° h1**ï¼Œåé¢è¿˜å‰© 24 ä¸ªå­—èŠ‚ï¼Œ**æ ¹æ®é…ç½®çš„ f éœ€è¦å‡ ä¸ªå­—èŠ‚å°±å–å‡ ä¸ªå­—èŠ‚**

h2 å°±æ ¹æ®å…¬å¼è®¡ç®—å³å¯

```go
// CalcHash è®¡ç®— h1 çš„ï¼Œå…·ä½“åˆ†é…åˆ°å“ªä¸ªæ¡¶ï¼Œsha input % m
func (f *CuckooFilter) CalcHash(input []byte) (h1 uint64, err error) {
    // m æœ€å¤š 8 å­—èŠ‚ï¼Œè¿”å›å›ºå®š 32 å­—èŠ‚çš„æ•°æ®ï¼Œå–ä½™å³å¯
    sum := sha256.Sum256(input)

    // å–é¦– 8 å­—èŠ‚ï¼Œè½¬ä¸º uint64
    h1, err = fastRemain(binary.BigEndian.Uint64(sum[:8]), f.m)
    if err != nil {
        return
    }
    return
}
// CalcFinger è®¡ç®—æŒ‡çº¹
func (f *CuckooFilter) CalcFinger(input []byte) []byte {
    sum := sha256.Sum256(input)

    return sum[8:8+f.f>>3]
}

// AltHash è®¡ç®— h2 ä»¥åŠ KickOut çš„æ–°ä½ç½®çš„ï¼Œh1 ^ sha finger % m
func (f *CuckooFilter) AltHash(h uint64, finger []byte) (uint64, error) {
    fingerHash, err := f.CalcHash(finger)
    if err != nil {
        return 0, err
    }

    return h ^ fingerHash, nil
}
```

#### æ¡¶çš„åŸºç¡€æ“ä½œ

åŒ…å«æ¡¶æ˜¯å¦æœ‰ç©ºä½ï¼Œæ¡¶å†…æ˜¯å¦æœ‰ç›®æ ‡æŒ‡çº¹ï¼Œæ¡¶ç‰¹å®šä½ç½®çš„æŒ‡çº¹æ•°æ®ï¼Œæ¡¶ç‰¹å®šä½ç½®æ›¿æ¢ç­‰ç­‰åŸºç¡€åŠŸèƒ½ï¼Œ**æœ¬è´¨ä¸Šå°±æ˜¯å¯¹ bucket æ•°ç»„çš„æ“ä½œ**ï¼Œä¾›éšåçš„ä¸Šå±‚æ“ä½œè°ƒç”¨

```go
// CheckBucketFull æ£€æŸ¥æ¡¶æ˜¯ä¸æ˜¯æ»¡çš„ï¼Œæ£€æŸ¥æœ€åä¸€ä¸ª finger å³å¯
func (f *CuckooFilter) CheckBucketFull(index uint64) bool {
    lastFinger := f.GetBucketFinger(index, f.b - 1)

    for i := 0; i < len(lastFinger); i++ {
        if uint8(lastFinger[i]) != 0 {
            return true
        }
    }
    return false
}

// CheckBucketHaveFinger æ£€æŸ¥æ¡¶å†…æ˜¯å¦æœ‰è¿™ä¸ªæŒ‡çº¹
func (f *CuckooFilter) CheckBucketHaveFinger(index uint64, finger []byte) bool {
    empty := f.GetEmptyFinger()

    for i := uint64(0); i < f.b; i++ {
        currFinger := f.GetBucketFinger(index, i)
        if bytes.Equal(currFinger, finger) {
            return true
        }
        if bytes.Equal(currFinger, empty) {
            // ç©ºäº†å°±ä¸ç”¨æ¯”äº†
            return false
        }
    }
    return false
}

// InsertBucket æ¡¶å†…æ’å…¥æ•°æ®
func (f *CuckooFilter) InsertBucket(index uint64, finger []byte) error {
    empty := f.GetEmptyFinger()
    // æ‰¾åˆ°ä¸€ä¸ªç©ºçš„ä½ç½®å°±å¯ä»¥æ”¾è¿›å»äº†
    for i := uint64(0); i < f.b; i++ {
        currFinger := f.GetBucketFinger(index, i)
        if bytes.Equal(currFinger, empty) {
            f.ReplaceBucket(index, i, finger)
            return nil
        }
    }
    return errors.New("bucket fulled")
}

// ReplaceBucket æ›¿æ¢ Bucket ä¸­æŸä¸ª finger
func (f *CuckooFilter) ReplaceBucket(index uint64, bucketIndex uint64, finger []byte) []byte {
    origin := f.GetBucketFinger(index, bucketIndex)

    for i := 0; i < len(finger); i++ {
        origin[i] = finger[i]
    }

    return origin
}
func (f *CuckooFilter) GetBucketFinger(index uint64, bucketIndex uint64) []byte {
    fingerByte := f.f>>3
    bucketBase := index * f.b * fingerByte

    return f.bucket[bucketBase+bucketIndex*fingerByte:bucketBase+(bucketIndex+1)*fingerByte]
}

func (f *CuckooFilter) GetEmptyFinger() []byte {
    fingerByte := f.f>>3
    return make([]byte, fingerByte)
}

// RandomReplaceInFullBucket éšæœºæ›¿æ¢æ»¡æ¡¶ä¸­çš„æŸä¸ª finger
func (f *CuckooFilter) RandomReplaceInFullBucket(index uint64, finger []byte) (replaceFinger []byte, err error) {
    if !f.CheckBucketFull(index) {
        return nil, errors.New("bucket not full")
    }
    randomIndex := uint64(rand.Intn(int(f.b)))

    replaceFinger= f.ReplaceBucket(index, randomIndex, finger)

    return
}

// DeleteFingerFromBucket ä»æ¡¶ä¸­åˆ é™¤ fingerï¼Œç±»ä¼¼æ•°ç»„æ“ä½œ
func (f *CuckooFilter) DeleteFingerFromBucket(index uint64, finger []byte) error {
    empty := f.GetEmptyFinger()

    for i := uint64(0); i < f.b; i++ {
        currFinger := f.GetBucketFinger(index, i)
        if bytes.Equal(currFinger, finger) {
            f.ReplaceBucket(index, i, empty)
            for j := i; j < f.b; j++ {
                if j == f.b-1 {
                    f.ReplaceBucket(index, j, empty)
                } else {
                    nextFinger := f.GetBucketFinger(index, j + 1)
                    f.ReplaceBucket(index, j, nextFinger)
                }
            }
            return nil
        }
    }
    return errors.New("finger not found")
}

// GetHashFinger è·å– finger
func (f *CuckooFilter) GetHashFinger(input []byte) (h1 uint64, h2 uint64, finger []byte, err error) {
    h1, err = f.CalcHash(input)
    if err != nil {
        return
    }

    finger = f.CalcFinger(input)

    h2, err = f.AltHash(h1, finger)

    return
}
```

### åˆ¤æ–­åŒ…å«

åœ¨ä¸Šé¢å®ç°çš„æ¡¶åŸºæœ¬åŠŸèƒ½å‰æä¸‹ï¼ŒåŒ…å«å°±å¾ˆç®€å•äº†ï¼Œçœ‹æ˜¯ä¸æ˜¯åœ¨ h1 å’Œ h2 é‡Œå°±å¥½

```go
// Contain æ˜¯å¦åŒ…å«
func (f *CuckooFilter) Contain(input []byte) (bool, error) {
    h1, h2, finger, err := f.GetHashFinger(input)
    if err != nil {
        return false, err
    }
    return f.CheckBucketHaveFinger(h1, finger) || f.CheckBucketHaveFinger(h2, finger), nil
}
```

### æ’å…¥

æ’å…¥ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œæ•´ä½“æ€è·¯ä¹Ÿå›´ç»•ç€

- h1 å’Œ h2 æœ‰ç©ºçš„å°±æ”¾è¿›å»

- æ²¡æœ‰ç©ºçš„å°±éšæœºæŠŠå…ƒç´ è¸¢å‡ºå»ï¼ŒæŠŠæ¢å‡ºæ¥çš„å…ƒç´ æ¢ä¸ªåœ°æ–¹å­˜

```go
// Add åŠ ä¸€ä¸ª
func (f *CuckooFilter) Add(input []byte) error {
    h1, h2, finger, err := f.GetHashFinger(input)
    if err != nil {
        return err
    }

    h1Full := f.CheckBucketFull(h1)
    h2Full := f.CheckBucketFull(h2)

    rand.Seed(time.Now().UnixNano())
    if !h1Full || !h2Full {
        index := uint64(0)
        if !h1Full && !h2Full {
            // éšæœºé€‰æ‹© h1 å’Œ h2ï¼Œæœ‰ç©ºä½å°±æ’å…¥
            if rand.Intn(2) > 0 {
                index = h1
            } else {
                index = h2
            }
        } else if !h1Full {
            index = h1
        } else {
            index = h2
        }
        // æ”¾åˆ°æ¡¶é‡Œ
        err = f.InsertBucket(index, finger)
        if err != nil {
            return err
        }
        // æˆåŠŸ
        return nil
    } else {
        // kick out
        // éšæœºé€‰æ‹© h1 å’Œ h2
        currIndex := uint64(0)
        if rand.Intn(2) > 0 {
            currIndex = h1
        } else {
            currIndex = h2
        }
        currFinger := finger
        for i:= 0; i < MaxKickOut; i++ {
            if f.CheckBucketFull(currIndex) {
                // æ»¡äº†æ²¡ç©ºä½ï¼Œå°±éšæœºæ›¿æ¢å‡ºæ¥
                currFinger, err = f.RandomReplaceInFullBucket(currIndex, currFinger)
                if err != nil {
                    return err
                }

                // æŠŠæ¢å‡ºæ¥çš„æ•°æ®ï¼Œæ¢ä¸€ä¸ªæ¡¶å­˜
                currIndex, err = f.AltHash(currIndex, currFinger)
                if err != nil {
                    return err
                }
            } else {
                // æœ‰ç©ºä½å°±æ’
                err = f.InsertBucket(currIndex, currFinger)
                if err != nil {
                    return err
                }
                // æˆåŠŸ
                return nil
            }
        }

        return errors.New("over max kick out")
    }
}
```

### åˆ é™¤

æ•´ä½“é€»è¾‘å°±æ˜¯ï¼Œh1 å’Œ h2 èƒ½æ‰¾åˆ°å°±åˆ ï¼Œæ‰¾ä¸åˆ°å°±åˆ ä¸äº†

```go
// Delete åˆ é™¤ä¸€ä¸ª
func (f *CuckooFilter) Delete(input []byte) error {
    h1, h2, finger, err := f.GetHashFinger(input)
    if err != nil {
        return err
    }

    // å¦‚æœèƒ½æ‰¾åˆ°çš„è¯ï¼Œå°±åˆ æ‰
    if f.CheckBucketHaveFinger(h1, finger) {
        return f.DeleteFingerFromBucket(h1, finger)
    }
    if f.CheckBucketHaveFinger(h2, finger) {
        return f.DeleteFingerFromBucket(h2, finger)
    }

    return errors.New("finger not found")
}
```

### æµ‹è¯•ç”¨ä¾‹

æœ€åŸºæœ¬çš„ç”¨æ³•å¦‚ä¸‹ï¼Œç»“æœåº”è¯¥æ˜¯ `false, true`

```go
func main() {
    filter, err := New(1<<5, 2, 8)
    if err != nil {
        fmt.Println("err", err)
        return
    }

    _ = filter.Add([]byte("Hello"))
    _ = filter.Add([]byte("World"))

    res1, err := filter.Contain([]byte("hello"))
    res2, err := filter.Contain([]byte("Hello"))

    if err != nil {
        fmt.Println("filter contain", err)
        return
    }

    fmt.Println("hello", res1, "Hello", res2)
}
```

æ‰©å±•ä¸€äº›ç‰¹æ®Šçš„æƒ…å†µï¼Œæ¯”å¦‚æ’å…¥å¤§é‡é‡å¤æ•°æ®é€ æˆçš„è¸¢å‡ºè¶…é™ï¼Œåˆ¤é‡ï¼Œåˆ é™¤ç­‰ç­‰ï¼Œå¯å‚è§ä»£ç ä¸­çš„ `filter_test.go`

æ‰§è¡Œ `go test .` è¿è¡Œæµ‹è¯•ç”¨ä¾‹çš„ç»“æœ

![](../static/assets/2022-05-18-20-46-48-image.png)

## æ€»ç»“

å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼Œç®—æ³•ç¡®å®æŒºå¥‡å¦™çš„ï¼Œä½†ç†è§£äº†å…¶ä¸­æ•°æ®ç»“æ„ä»¥åŠæ ¸å¿ƒçš„ h1 ã€h2 ã€finger ä¹‹é—´çš„è¿ç®—å’Œè½¬æ¢å…³ç³»ï¼Œå°±ä¼šå˜çš„ç®€å•èµ·æ¥ã€‚
